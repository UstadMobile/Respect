appId: world.respect.app
onFlowStart:
  - clearState: world.respect.app
  - runScript:
      file: "scripts/school_init.js"
      env:
        TESTCONTROLLER_URL: ${TESTCONTROLLER_URL}
        SCHOOL_ADMIN_PASSWORD: ${SCHOOL_ADMIN_PASSWORD}
        DIR_ADMIN_AUTH_HEADER: ${DIR_ADMIN_AUTH_HEADER}
        SCHOOL_URL: ${SCHOOL_URL}
        SCHOOL_NAME: ${SCHOOL_NAME}
        URL_SUBSTITUTION: ${URL_SUBSTITUTION}
        NAME: "002_browse_lessons_test"

onFlowComplete:
  - runScript:
      file: "scripts/teardown.js"
---
- runFlow: "subflows/school_admin_login_flow.yaml"

- tapOn:
    id: "floating_action_button"
- tapOn: "Add from Link"
- tapOn: "Link*"
- inputText: "https://respect.world/respect-ds/case_valid/appmanifest.json"
- tapOn: "Next"
- assertVisible:
    id: "app_title"
    text: "App detail"
- assertVisible: "My app"
- assertVisible: "Add App"
# verify App got added to Apps section
- tapOn: "Add App"
- tapOn: "Apps"
- assertVisible:
    id: "app_title"
    text: "Apps"
- assertVisible: "My app"
- tapOn: "My app"
- assertVisible: "Lessons"
- tapOn: "Lessons"
- tapOn: "Grade 1"
- tapOn: "Lesson 001"
- assertVisible: "Lesson 001"
- assertVisible: "App name"
- tapOn: "Open"
- extendedWaitUntil:
    visible: "Lesson 001"
    timeout: 1000
- assertVisible: "Hello World Lesson"
- tapOn: "Close"

- tapOn: "Apps"
- assertVisible:
    id: "app_title"
    text: "Apps"

#----------------- Add metadata test here --------------#

# Open Search/Filter View
- tapOn:
    id: "search_icon"

# Verify Filter Categories exist
- assertVisible: "Language"
- assertVisible: "Grade"
- assertVisible: "Subject"
- assertVisible: "Type"

# Test Language Filter
- tapOn: "Language"
- assertVisible:
    id: "english" # Ensure the option has loaded
- tapOn: "English"
# Verify the generic "Language" label is replaced by the specific selection
- assertNotVisible: "Language"
- assertVisible: "English"

# Verify Content Filtered
- extendedWaitUntil:
    visible: "Lesson 001"
    timeout: 3000

# Verify UI logic for other filters
- tapOn: "Grade"
- assertVisible: "Grade 1"
- tapOn: "Subject"
- assertVisible: "English"
- assertVisible: "Math"
- tapOn: "Type"
- assertVisible: "Game"
- assertVisible: "Book"

# Test Clear Filters
- tapOn: "Clear all"
# Verify "English" selection is gone and generic "Language" label returns
- assertNotVisible: "English"
- assertVisible: "Language"

# Test Text Search
- tapOn:
    id: "search_icon"
- inputText: "Lesson 001" # Removed underscore to match likely visible text
# Verify Search Result
- extendedWaitUntil:
    visible: "Lesson 001"
    timeout: 3000

# Test Clear Search Text
- tapOn:
    id: "delete_icon" # The 'X' in the search bar
- assertVisible: "Lesson 002"
- assertNotVisible: "Lesson 001" #--- Need clarification here - when 'X' clicked, all items visible or all gets hidden?

